<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Codex Collection ‚Äî The Tempest Rebuild (Season 2)</title>
<meta name="description" content="Codex Collection reveal ‚Äî LEGO Fortnite: Storm King tie-in. Hourly unblur from Nov 17 ‚Üí Nov 22. Owner: XX Weekly. Collab: BiniFn.">
<style>
  :root{
    --yellow:#facc15;
    --yellow-600:#eab308;
    --blue:#3b82f6;
    --blue-700:#1e40af;
    --bg-1:#071428;
    --bg-2:#021022;
    --text:#ffffff;
    --max-blur:110px;
    --container-w:1100px;
    --radius:12px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,monospace;
    color:var(--text);
    min-height:100vh; display:flex; align-items:center; justify-content:center;
    background:
      radial-gradient(circle at 12% 18%, rgba(59,130,246,0.06), transparent 12%),
      radial-gradient(circle at 88% 86%, rgba(250,204,21,0.04), transparent 12%),
      linear-gradient(180deg,var(--bg-1) 0%, var(--bg-2) 70%);
    padding:18px; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  /* snow canvas background */
  .bg-snow{ position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); }
  #snowCanvas{ position:absolute; inset:0; width:100%; height:100%; mix-blend-mode:screen; opacity:0.95; }

  /* stage */
  .stage{ position:relative; z-index:4; width:100%; max-width:var(--container-w); display:flex; flex-direction:column; gap:18px; align-items:center; padding:18px; box-sizing:border-box; }

  /* intro overlay */
  .intro-overlay{ position:fixed; inset:0; z-index:15000; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(0,0,0,0.92), rgba(0,0,0,0.96)); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); }
  .intro-card{ width:min(980px,94%); background:linear-gradient(180deg,#04060a,#060714); border-radius:12px; padding:20px; border:1px solid rgba(255,255,255,0.03); box-shadow:0 40px 120px rgba(0,0,0,0.7); color:#dff2ff; }
  .retro-header{ display:flex; gap:12px; align-items:center; margin-bottom:10px; }
  .avatar{ width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:900;color:#06243c;font-family:"Courier New",monospace; box-shadow:0 8px 30px rgba(0,0,0,0.6); }
  .avatar.xw{ background:linear-gradient(180deg,var(--blue),var(--blue-700)); }
  .avatar.bini{ background:linear-gradient(180deg,var(--yellow), #f3d14a); }
  .intro-title{ font-weight:900; font-size:1.12rem; color:var(--yellow-600); letter-spacing:.02em; }
  .dialog-box{ background:linear-gradient(180deg,#03040a,#020409); border-radius:10px; padding:14px; border:1px solid rgba(255,255,255,0.03); min-height:160px; font-family:"Courier New",monospace; font-size:0.98rem; line-height:1.6; color:#e9f6ff; overflow:auto; }
  .dialog-line{ white-space:pre-wrap; }
  .prompt{ margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .skip-btn{ padding:8px 12px; border-radius:8px; background:var(--blue); color:#fff; border:0; font-weight:800; cursor:pointer; box-shadow:0 10px 30px rgba(0,0,0,0.45); }
  .small-muted{ color:rgba(255,255,255,0.56); font-weight:700; font-size:0.86rem; }

  /* header */
  .header{ text-align:center; z-index:4; }
  .title{ font-size:clamp(1.6rem,4vw,2.6rem); font-weight:900; letter-spacing:.02em; color:var(--text); text-shadow:0 10px 30px rgba(0,0,0,0.6); }
  .subtitle{ font-size:0.95rem; color:rgba(255,255,255,0.78); margin-top:6px; font-weight:700; }

  /* reveal area */
  .reveal-area{ width:100%; display:flex; align-items:center; justify-content:center; padding:8px 0; min-height:54vh; max-height:78vh; box-sizing:border-box; position:relative; z-index:3; }
  .logo-wrap{ position:relative; width:min(860px,92%); max-width:960px; display:flex; align-items:center; justify-content:center; border-radius:12px; overflow:visible; }
  img.codex-logo{ width:100%; height:auto; display:block; border-radius:12px; transition: filter 700ms linear, transform 700ms ease; filter: blur(var(--max-blur)); box-shadow: 0 48px 120px rgba(2,6,23,0.7); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); }

  /* storm silhouette */
  .storm-sil{ position:absolute; inset:-6% -6% -6% -6%; z-index:2; pointer-events:none; opacity:0; transition:opacity 420ms ease; background-repeat:no-repeat; background-position:center; background-size:contain; filter: drop-shadow(0 40px 120px rgba(0,0,0,0.6)) hue-rotate(10deg) saturate(0.85); }

  /* info */
  .info{ width:100%; max-width:860px; display:flex; flex-direction:column; align-items:center; gap:10px; margin-top:6px; z-index:3; }
  .progress-line{ width:100%; display:flex; flex-direction:column; gap:8px; align-items:center; }
  .progress-bar-bg{ width:86%; height:12px; background: rgba(255,255,255,0.03); border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,0.04); }
  .progress-bar-fill{ width:0%; height:100%; background: linear-gradient(90deg,var(--yellow-600),var(--blue)); box-shadow: 0 0 18px rgba(58,123,213,0.12); transition: width 700ms ease; border-radius:999px; }
  .progress-percent{ color:var(--text); font-weight:900; font-size:0.95rem; margin-top:6px; letter-spacing:.03em; }

  .countdown{ color:rgba(255,255,255,0.96); font-weight:800; font-size:1.02rem; margin-top:6px; text-align:center; }
  .next-unblur{ margin-top:8px; font-size:0.98rem; color:rgba(255,255,255,0.92); font-weight:800; }

  .lore-tip{ margin-top:8px; font-size:0.9rem; color:rgba(255,255,255,0.85); background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.04)); padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }

  /* menu */
  .menu-btn{ position: fixed; right:18px; bottom:18px; z-index:14000; width:56px; height:56px; border-radius:999px; background: linear-gradient(135deg,var(--yellow-600),var(--blue)); border:0; box-shadow: 0 18px 48px rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; font-weight:900; color:#06243c; cursor:pointer; }
  .menu-panel{ position: fixed; right:18px; bottom:86px; z-index:14000; width:300px; max-width:92vw; background: linear-gradient(180deg,#071627,#041225); border-radius:12px; padding:10px; display:none; flex-direction:column; gap:8px; box-shadow:0 30px 80px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03); }
  .menu-link{ display:block; padding:10px 12px; background:rgba(255,255,255,0.02); border-radius:10px; color:var(--text); font-weight:800; text-decoration:none; border:1px solid rgba(255,255,255,0.02); text-align:left; cursor:pointer; }
  .menu-link:hover{ transform: translateY(-3px); transition: transform .12s ease; }

  /* credits */
  .credits-modal{ position: fixed; inset:0; display:none; z-index:15000; align-items:center; justify-content:center; background: rgba(0,0,0,0.74); }
  .credits-card{ width:min(540px,92%); background: linear-gradient(180deg,#061225,#041021); padding:18px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); box-shadow:0 30px 80px rgba(0,0,0,0.6); color:var(--text); font-weight:700; text-align:center; }
  .credits-card a{ color:var(--yellow); text-decoration:none; font-weight:900; }
  .credits-close{ margin-top:12px; padding:8px 12px; border-radius:8px; background:var(--blue); color:#fff; font-weight:900; border:0; cursor:pointer; }

  .final-banner{ margin-top:12px; font-weight:900; color:var(--yellow); text-shadow:0 6px 30px rgba(30,64,175,0.12); display:none; }
  .watermark{ position: fixed; bottom:10px; left:50%; transform:translateX(-50%); font-size:13px; color:rgba(255,255,255,0.18); z-index:14000; pointer-events:none; }

  .confetti-piece{ position:fixed; z-index:99999; pointer-events:none; border-radius:3px; }

  @media (max-width:780px){
    .menu-panel{ right:12px; bottom:76px; width:88vw; }
    .logo-wrap{ width:96%; }
    .progress-bar-bg{ width:92%; }
    .dialog-box{ min-height:120px; font-size:0.95rem; }
  }

  @media (prefers-reduced-motion: reduce){
    img.codex-logo{ transition: none !important; }
  }
</style>
</head>
<body>
  <!-- Hidden looping YouTube iframe (muted autoplay by default) -->
  <!-- Uses secure YouTube embed (HTTPS). The video ID: BeZSvjNYc70 -->
  <iframe id="musicIframe"
          src="https://www.youtube.com/embed/BeZSvjNYc70?autoplay=1&loop=1&playlist=BeZSvjNYc70&mute=1&controls=0&modestbranding=1&rel=0"
          width="0" height="0" frameborder="0" allow="autoplay; encrypted-media" style="display:none;"></iframe>

  <div class="bg-snow" id="bgSnow">
    <canvas id="snowCanvas" aria-hidden="true"></canvas>
  </div>

  <!-- Intro overlay (lore cinematic) -->
  <div class="intro-overlay" id="introOverlay" role="dialog" aria-modal="true" aria-hidden="false">
    <div class="intro-card" role="document" aria-label="Codex Prelude">
      <div class="retro-header" aria-hidden="true">
        <div class="avatar xw" title="XX Weekly (owner)">XW</div>
        <div>
          <div class="intro-title">CODŒûX REBOOT ‚Äî Prelude</div>
          <div style="font-size:.85rem;color:rgba(255,255,255,0.6);">Bridge Protocol Active ‚Äî connecting fragments...</div>
        </div>
      </div>

      <div class="dialog-box" id="dialogBox" aria-live="polite">
        <div id="dialogText" class="dialog-line"></div>
      </div>

      <div class="prompt">
        <div class="small-muted">Owner: XX Weekly ‚Äî Collaborator: BiniFn</div>
        <div style="display:flex;gap:8px">
          <button id="skipIntro" class="skip-btn" aria-label="Skip intro">Skip Intro</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main stage -->
  <main class="stage" role="main" aria-live="polite">
    <header class="header" role="banner">
      <div class="title">Codex Collection</div>
      <div class="subtitle">The Tempest Rebuild ‚Äî Nov 17 ‚Üí Nov 22 ‚Äî LEGO Fortnite</div>
    </header>

    <section class="reveal-area" role="region" aria-label="Codex reveal">
      <div class="logo-wrap" id="logoWrap">
        <div id="stormSil" class="storm-sil" aria-hidden="true"></div>
        <img id="codexLogo" class="codex-logo" alt="Codex Collection Book (revealing)">
      </div>
    </section>

    <section class="info" role="region" aria-label="status and controls">
      <div class="progress-line" aria-hidden="true">
        <div class="progress-bar-bg" aria-hidden="true"><div id="progressFill" class="progress-bar-fill" style="width:0%"></div></div>
        <div id="progressPercent" class="progress-percent">0%</div>
      </div>

      <div id="countdown" class="countdown">Reveal begins Nov 17 ‚Äî prepare</div>
      <div id="nextUnblur" class="next-unblur">Next clarity update in: --:--:--</div>

      <div class="lore-tip" id="loreTip" aria-hidden="false">
        Story: After Season 1's rift, the Codex scattered. The Storm King has been feeding on fragments‚Äî the snow biome is where the book reforms.
      </div>

      <div id="finalBanner" class="final-banner">Codex Collection ‚Äî Now Unveiled</div>
    </section>
  </main>

  <!-- Menu -->
  <button id="menuBtn" class="menu-btn" aria-haspopup="true" aria-expanded="false" aria-label="Open menu">‚ò∞</button>
  <div id="menuPanel" class="menu-panel" role="menu" aria-hidden="true">
    <button class="menu-link" id="watchBtn">‚ñ∂ Watch Codex Reveal Playlist</button>
    <button class="menu-link" id="seasonBtn">üé¨ Watch Season 1</button>
    <button class="menu-link" id="ownerBtn">üëë XX Weekly</button>
    <button class="menu-link" id="collabBtn">ü§ù BiniFn</button>
    <button class="menu-link" id="musicToggle">‚ô´ Toggle Music</button>
    <button class="menu-link" id="creditsBtn">üìú Credits</button>
    <button class="menu-link" id="menuClose">Close</button>
  </div>

  <!-- credits modal -->
  <div id="creditsModal" class="credits-modal" aria-hidden="true" role="dialog">
    <div class="credits-card" role="document">
      <div style="font-size:1.05rem;font-weight:900;margin-bottom:6px">Credits & Notes</div>
      <div style="margin-top:6px;text-align:left">
        <strong>Owner:</strong> <a href="https://youtube.com/@weeklyofficial_2025" target="_blank" rel="noopener noreferrer">@weeklyofficial_2025</a><br>
        <strong>Collaborator:</strong> <a href="https://youtube.com/@binifn.x" target="_blank" rel="noopener noreferrer">@binifn.x</a><br>
        <div style="margin-top:8px;color:rgba(255,255,255,0.82)">Lore: The Storm King reformed fragments of the Codex after Season 1's rift ‚Äî this reveal visualizes the book's cover becoming whole again.</div>
      </div>
      <button id="closeCredits" class="credits-close" aria-label="Close credits">Close</button>
    </div>
  </div>

  <div class="watermark">¬© 2025 XX Weekly &amp; BiniFn ‚Äî All Rights Reserved</div>
  <div id="confettiRoot" aria-hidden="true"></div>

<script>
/* ---------------- CONFIG ---------------- */
const LOGO_SRC = "https://cdn.discordapp.com/attachments/1383490758539087904/1437190455828811978/IMG-20251109-WA0061.jpg?ex=6913002a&is=6911aeaa&hm=fef8b47a9b150727d12bf9eabbe19f28487cbb158b37509be86f1110cb513c72&";
const PLAYLIST_URL = "https://youtube.com/playlist?list=PLuHsYM1bT174ZiVwEPvgpFl1poTaHjCRD";
const SEASON1_URL = "https://youtube.com/playlist?list=PLMHItU_I4Deoshyoz8DZYwksaUW8Q4uDV";
const OWNER_URL = "https://youtube.com/@weeklyofficial_2025";
const COLLAB_URL = "https://youtube.com/@binifn.x";

/* Reveal timeframe (local): Nov 17 00:00 -> Nov 22 00:00 */
const START = new Date(2025, 10, 17, 0, 0, 0);
const END   = new Date(2025, 10, 22, 0, 0, 0);
const MAX_BLUR = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--max-blur')) || 110;

/* ---------------- DOM ---------------- */
const introOverlay = document.getElementById('introOverlay');
const dialogText = document.getElementById('dialogText');
const skipIntro = document.getElementById('skipIntro');

const codexLogo = document.getElementById('codexLogo');
const progressFill = document.getElementById('progressFill');
const progressPercent = document.getElementById('progressPercent');
const countdown = document.getElementById('countdown');
const nextUnblur = document.getElementById('nextUnblur');
const finalBanner = document.getElementById('finalBanner');
const loreTip = document.getElementById('loreTip');

const stormSil = document.getElementById('stormSil');

const menuBtn = document.getElementById('menuBtn');
const menuPanel = document.getElementById('menuPanel');
const watchBtn = document.getElementById('watchBtn');
const seasonBtn = document.getElementById('seasonBtn');
const ownerBtn = document.getElementById('ownerBtn');
const collabBtn = document.getElementById('collabBtn');
const musicToggleBtn = document.getElementById('musicToggle');
const creditsBtn = document.getElementById('creditsBtn');
const menuClose = document.getElementById('menuClose');

const creditsModal = document.getElementById('creditsModal');
const closeCredits = document.getElementById('closeCredits');

const confettiRoot = document.getElementById('confettiRoot');
const snowCanvas = document.getElementById('snowCanvas');
const musicIframe = document.getElementById('musicIframe');

const INTRO_STORAGE_KEY = 'codex_intro_seen_v4';

/* ---------------- Intro script (the lore you approved) ---------------- */
const introLines = [
  {who:'BiniFn', color:'#f3d14a', text:"Yo Weekly‚Ä¶ is this thing recording again?"},
  {who:'XX Weekly', color:'#64b5f6', text:"Yup. System reboot successful. We‚Äôre back‚Äî but the world isn‚Äôt the same."},
  {who:'BiniFn', color:'#f3d14a', text:"After that rift explosion last season‚Ä¶ the entire LEGO Fortnite realm split apart."},
  {who:'XX Weekly', color:'#64b5f6', text:"The Codex shattered into thousands of pages, scattered across biomes."},
  {who:'BiniFn', color:'#f3d14a', text:"So that‚Äôs why we lost connection for weeks üíÄ"},
  {who:'XX Weekly', color:'#64b5f6', text:"While we were offline, the storms grew stronger. The Storm King‚Äî a remnant of the old cube energy‚Äî woke up. He‚Äôs been feeding on those scattered Codex pages ever since ‚ö°üìñ"},
  {who:'BiniFn', color:'#f3d14a', text:"So he‚Äôs literally rewriting the island‚Äôs code?!"},
  {who:'XX Weekly', color:'#64b5f6', text:"Exactly. The snow biome you‚Äôre seeing now? That‚Äôs the Bridge. A frozen data field holding the Codex‚Äôs fragments together."},
  {who:'BiniFn', color:'#f3d14a', text:"That explains the static, the cold‚Ä¶ the whispers üëÄ"},
  {who:'XX Weekly', color:'#64b5f6', text:"The Codex is fighting back‚Äî every hour, it unblurs a little. By November 22, it‚Äôll fully awaken, and the bridge will open again."},
  {who:'BiniFn', color:'#f3d14a', text:"And when it does‚Ä¶?"},
  {who:'XX Weekly', color:'#64b5f6', text:"The Storm King will come for it."},
  {who:'BiniFn', color:'#f3d14a', text:"Broooo that‚Äôs insane üò≠ we‚Äôre really doing this again?!"},
  {who:'XX Weekly', color:'#64b5f6', text:"Always. This is Season 2 ‚Äî The Tempest Rebuild."},
  {who:'NARR', color:'#ffffff', text:"System reboot in 3‚Ä¶ 2‚Ä¶ 1‚Ä¶"},
  {who:'NARR', color:'#ffffff', text:"CODŒûX REVEAL INITIALIZING‚Ä¶"}
];

/* ---------------- Utilities ---------------- */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function typeWriter(el, text, speed=36){
  el.textContent = '';
  for (let i=0;i<text.length;i++){
    el.textContent += text[i];
    await sleep(speed + Math.floor(Math.random()*8));
  }
}

/* ---------------- Snow canvas (lightweight) ---------------- */
let ctx = null;
let flakes = [];
function setupSnow(){
  if(!snowCanvas || !snowCanvas.getContext) return;
  ctx = snowCanvas.getContext('2d');
  resizeCanvas();
  createFlakes(34);
  startSnow();
}
function resizeCanvas(){
  if(!snowCanvas) return;
  const dpr = window.devicePixelRatio || 1;
  snowCanvas.width = Math.floor(window.innerWidth * dpr);
  snowCanvas.height = Math.floor(window.innerHeight * dpr);
  snowCanvas.style.width = window.innerWidth + 'px';
  snowCanvas.style.height = window.innerHeight + 'px';
  if(ctx) ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', ()=> resizeCanvas(), {passive:true});

function createFlakes(n=28){
  flakes = [];
  for (let i=0;i<n;i++){
    flakes.push({
      x: Math.random()*window.innerWidth,
      y: Math.random()*-window.innerHeight,
      size: 4 + Math.random()*18,
      speed: 18 + Math.random()*84,
      drift: (Math.random()-0.5)*26,
      rot: Math.random()*360,
      rotSpeed: (Math.random()-0.5)*3,
      alpha: 0.25 + Math.random()*0.9
    });
  }
}

let animId = null;
function drawSnow(){
  if(!ctx) return;
  ctx.clearRect(0,0,snowCanvas.width, snowCanvas.height);
  ctx.save();
  for(let i=0;i<flakes.length;i++){
    const f = flakes[i];
    f.y += (f.speed/100) * (1 + Math.sin(Date.now()/4000 + i));
    f.x += f.drift * 0.02;
    f.rot += f.rotSpeed * 0.02;
    if(f.y > window.innerHeight + 80){
      f.y = -40 - Math.random()*140;
      f.x = Math.random()*window.innerWidth;
    }
    const grad = ctx.createRadialGradient(f.x, f.y, 0, f.x, f.y, f.size);
    grad.addColorStop(0, `rgba(255,255,255,${Math.min(1,f.alpha)})`);
    grad.addColorStop(1, `rgba(255,255,255,0)`);
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.arc(f.x, f.y, f.size*0.6, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.restore();
  animId = requestAnimationFrame(drawSnow);
}
function startSnow(){ if(!animId) drawSnow(); }
function stopSnow(){ if(animId){ cancelAnimationFrame(animId); animId = null; } }

/* ---------------- Storm silhouette effect ---------------- */
function showStormSilhouette(ms=700){
  const svg = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 600"><defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#1e3a8a"/><stop offset="1" stop-color="#0ea5e9"/></linearGradient></defs><g opacity="0.95"><path d="M1200 300 C900 170 750 60 600 80 C450 100 300 240 0 200 L0 600 L1200 600 Z" fill="url(#g)"/></g></svg>`);
  stormSil.style.backgroundImage = `url('${svg}')`;
  stormSil.style.opacity = '0.0';
  requestAnimationFrame(()=> {
    stormSil.style.transition = 'opacity 380ms ease';
    stormSil.style.opacity = '0.9';
    setTimeout(()=> { stormSil.style.opacity = '0'; }, ms);
  });
}

/* small cinematic flash */
function flashWhite(ms=420){
  return new Promise(res=>{
    const el = document.createElement('div');
    el.style.position='fixed'; el.style.inset=0; el.style.zIndex=14999;
    el.style.pointerEvents='none'; el.style.background='radial-gradient(circle, rgba(255,255,255,0.85), rgba(255,255,255,0.6))';
    el.style.opacity = '0';
    document.body.appendChild(el);
    requestAnimationFrame(()=>{ el.style.transition='opacity 140ms ease'; el.style.opacity='1'; });
    setTimeout(()=>{ el.style.transition='opacity 420ms ease'; el.style.opacity='0'; setTimeout(()=>{ el.remove(); res(); }, 460); }, ms);
  });
}

/* ---------------- Preload logo ---------------- */
function preloadLogo(){
  if(!LOGO_SRC) return;
  codexLogo.src = LOGO_SRC;
}

/* ---------------- Reveal computation (hourly) ---------------- */
function computeRevealState(){
  const now = new Date();
  const start = new Date(START.getFullYear(), START.getMonth(), START.getDate(), 0,0,0);
  const end = new Date(END.getFullYear(), END.getMonth(), END.getDate(), 0,0,0);
  const totalHours = Math.round((end - start)/(1000*60*60)); // e.g., 120
  const hoursPassed = Math.floor((now - start)/(1000*60*60));
  const clamped = Math.max(-1, Math.min(hoursPassed, totalHours));
  const step = clamped;
  const percent = step < 0 ? 0 : Math.round((step / Math.max(1,totalHours)) * 100);
  const beforeStart = hoursPassed < 0;
  const afterEnd = hoursPassed >= totalHours;
  const hoursRemaining = Math.max(0, totalHours - Math.max(0,hoursPassed));
  return { now, start, end, totalHours, hoursPassed, step, percent, beforeStart, afterEnd, hoursRemaining };
}

function secondsToNextHour(){
  const now = new Date();
  const next = new Date(now);
  next.setMinutes(0,0,0);
  next.setHours(next.getHours()+1);
  return Math.max(0, Math.floor((next - now)/1000));
}
function formatHMS(sec){
  const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
  const pad = n => String(n).padStart(2,'0');
  if(h>0) return `${h}h ${pad(m)}m ${pad(s)}s`;
  return `${m}m ${pad(s)}s`;
}

/* ---------------- UI update and timers ---------------- */
let uiInterval = null;
let secInterval = null;
let finalFired = false;
function updateUI(){
  const st = computeRevealState();
  const percent = st.percent;
  progressFill.style.width = percent + '%';
  progressPercent.textContent = percent + '%';
  const blurPx = Math.max(0, MAX_BLUR * (1 - (percent/100)));
  codexLogo.style.filter = `blur(${blurPx}px) saturate(${0.92 + percent/400}) contrast(${0.9 + percent/600})`;
  if(st.beforeStart) countdown.textContent = 'Reveal begins Nov 17 ‚Äî prepare.';
  else if(st.afterEnd) countdown.textContent = 'Reveal complete ‚Äî Nov 22';
  else {
    const daysLeft = Math.ceil(st.hoursRemaining / 24);
    countdown.textContent = `${daysLeft} day${daysLeft===1?'':'s'} until final reveal`;
  }
  const sec = secondsToNextHour();
  nextUnblur.textContent = `Next clarity update in: ${formatHMS(sec)}`;
  if(percent >= 100 && !finalFired){
    finalFired = true;
    onFinalReveal();
  }
}

function startTimers(){
  updateUI();
  if(uiInterval) clearInterval(uiInterval);
  if(secInterval) clearInterval(secInterval);
  uiInterval = setInterval(updateUI, 60*1000);
  secInterval = setInterval(()=> {
    const sec = secondsToNextHour();
    nextUnblur.textContent = `Next clarity update in: ${formatHMS(sec)}`;
    if(sec === 0) updateUI();
  }, 1000);
}

/* ---------------- Final reveal actions ---------------- */
function onFinalReveal(){
  finalBanner.style.display = 'block';
  try {
    codexLogo.animate([
      { transform: 'scale(1)' },
      { transform: 'scale(1.06)' },
      { transform: 'scale(1)' }
    ], { duration: 1600, iterations: 2, easing: 'cubic-bezier(.2,.9,.2,1)' });
  } catch(e){}
  confettiBurst(180);
  loreTip.textContent = 'Storm King detected ‚Äî the gateway will open soon. Prepare your squads.';
}

/* ---------------- Confetti ---------------- */
function confettiBurst(count=120){
  const colors = ['#facc15','#eab308','#3b82f6','#1e40af','#60a5fa','#f59e0b'];
  for(let i=0;i<count;i++){
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    const w = 6 + Math.floor(Math.random()*18);
    const h = 8 + Math.floor(Math.random()*10);
    el.style.width = w + 'px';
    el.style.height = h + 'px';
    el.style.left = (50 + (Math.random()-0.5)*70) + 'vw';
    el.style.top = (5 + Math.random()*20) + 'vh';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.opacity = '1';
    el.style.borderRadius = '2px';
    confettiRoot.appendChild(el);
    const dx = (Math.random()-0.5)*360;
    const dy = window.innerHeight * (0.45 + Math.random()*0.6);
    const rot = (Math.random()-0.5)*1200;
    try {
      el.animate([
        { transform: `translate3d(0,0,0) rotate(0deg)`, opacity: 1 },
        { transform: `translate3d(${dx}px, ${dy}px, 0) rotate(${rot}deg)`, opacity: 0 }
      ], { duration: 1400 + Math.random()*1200, easing: 'cubic-bezier(.2,.7,.2,1)', iterations:1, fill:'forwards' });
    } catch(e){
      setTimeout(()=> el.remove(), 1800 + Math.random()*1200);
    }
    setTimeout(()=> { try{ el.remove(); }catch(_){} }, 3600);
  }
}

/* ---------------- Menu actions ---------------- */
menuBtn.addEventListener('click', ()=>{
  const open = menuPanel.style.display === 'flex';
  if(open){ menuPanel.style.display = 'none'; menuBtn.setAttribute('aria-expanded','false'); }
  else { menuPanel.style.display = 'flex'; menuPanel.style.flexDirection = 'column'; menuBtn.setAttribute('aria-expanded','true'); }
});
menuClose.addEventListener('click', ()=> { menuPanel.style.display = 'none'; menuBtn.setAttribute('aria-expanded','false'); });
watchBtn.addEventListener('click', ()=> { window.open(PLAYLIST_URL, '_blank', 'noopener'); menuPanel.style.display='none'; });
seasonBtn.addEventListener('click', ()=> { window.open(SEASON1_URL, '_blank', 'noopener'); menuPanel.style.display='none'; });
ownerBtn.addEventListener('click', ()=> { window.open(OWNER_URL, '_blank', 'noopener'); menuPanel.style.display='none'; });
collabBtn.addEventListener('click', ()=> { window.open(COLLAB_URL, '_blank', 'noopener'); menuPanel.style.display='none'; });
creditsBtn.addEventListener('click', ()=> { creditsModal.style.display = 'flex'; creditsModal.setAttribute('aria-hidden','false'); menuPanel.style.display='none'; });
closeCredits.addEventListener('click', ()=> { creditsModal.style.display = 'none'; creditsModal.setAttribute('aria-hidden','true'); });

/* ---------------- Music toggle (user gesture required to unmute) ---------------- */
let musicMuted = true; // starts muted (autoplay allowed in most browsers)
function setMusicMutedStateUI(){
  musicToggleBtn.textContent = musicMuted ? '‚ô´ Music (Muted)' : '‚ô´ Music (Unmuted)';
}
setMusicMutedStateUI();

musicToggleBtn.addEventListener('click', ()=>{
  // user-gesture action: toggle music state by reloading iframe src (unmute if requested)
  if(musicMuted){
    // attempt to unmute using user gesture: load unmuted embed (may still be blocked by browser if autoplay restrictions)
    musicIframe.src = "https://www.youtube.com/embed/BeZSvjNYc70?autoplay=1&loop=1&playlist=BeZSvjNYc70&mute=0&controls=0&modestbranding=1&rel=0";
    musicMuted = false;
    setMusicMutedStateUI();
  } else {
    // mute again
    musicIframe.src = "https://www.youtube.com/embed/BeZSvjNYc70?autoplay=1&loop=1&playlist=BeZSvjNYc70&mute=1&controls=0&modestbranding=1&rel=0";
    musicMuted = true;
    setMusicMutedStateUI();
  }
  // hide menu
  menuPanel.style.display = 'none';
});

/* ---------------- Intro playback (robust) ---------------- */
let introCancelled = false;
async function playIntro(){
  try {
    if(localStorage.getItem(INTRO_STORAGE_KEY) === '1'){
      introOverlay.style.display = 'none';
      introOverlay.setAttribute('aria-hidden','true');
      initMain();
      return;
    }
  } catch(e){}

  // preload snow + logo + music iframe (muted) to avoid jank
  setupSnow();
  preloadLogo();

  introOverlay.style.display = 'flex';
  introOverlay.setAttribute('aria-hidden','false');
  dialogText.textContent = '';

  for(let i=0;i<introLines.length;i++){
    if(introCancelled) break;
    const ln = introLines[i];
    if(ln.who === 'NARR'){
      dialogText.style.textAlign = 'center';
      dialogText.style.fontWeight = '900';
      dialogText.style.color = ln.color;
      await typeWriter(dialogText, ln.text, 28);
    } else {
      dialogText.style.textAlign = 'left';
      dialogText.style.fontWeight = '700';
      dialogText.style.color = ln.color;
      await typeWriter(dialogText, `${ln.who}: ${ln.text}`, 36);
    }
    if(i === 5) { showStormSilhouette(900); } // show silhouette during Storm King line
    await sleep(700);
  }

  try { localStorage.setItem(INTRO_STORAGE_KEY, '1'); } catch(e){}
  await sleep(450);
  // cinematic wipe then init
  await flashWhite(280);
  hideIntroAndStart();
}

function hideIntroAndStart(){
  introCancelled = true;
  introOverlay.style.display = 'none';
  introOverlay.setAttribute('aria-hidden','true');
  initMain();
}

skipIntro.addEventListener('click', ()=> {
  try { localStorage.setItem(INTRO_STORAGE_KEY, '1'); } catch(e){}
  introCancelled = true;
  hideIntroAndStart();
});

/* ---------------- Init main UI ---------------- */
function initMain(){
  preloadLogo();
  codexLogo.style.filter = `blur(${MAX_BLUR}px)`;
  showStormSilhouette(700);
  startTimers();
  startSnow();
}

/* ---------------- Load / events ---------------- */
window.addEventListener('load', async ()=>{
  resizeCanvas();
  // reduced motion: skip intro
  const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  if(reduced){
    try { localStorage.setItem(INTRO_STORAGE_KEY, '1'); } catch(e){}
    introOverlay.style.display = 'none';
    initMain();
    return;
  }
  try {
    await playIntro();
  } catch(e){
    introOverlay.style.display = 'none';
    initMain();
  }
});

window.addEventListener('keydown', (e)=> {
  if(e.key === 'Escape'){
    if(menuPanel.style.display === 'flex'){ menuPanel.style.display='none'; menuBtn.setAttribute('aria-expanded','false'); }
    if(creditsModal.style.display === 'flex'){ creditsModal.style.display='none'; creditsModal.setAttribute('aria-hidden','true'); }
    if(introOverlay.style.display === 'flex'){ introCancelled = true; hideIntroAndStart(); }
  }
});

window.addEventListener('beforeunload', ()=> {
  if(uiInterval) clearInterval(uiInterval);
  if(secInterval) clearInterval(secInterval);
  stopSnow();
});

/* fallback if logo fails */
codexLogo.addEventListener('error', ()=>{
  codexLogo.style.display = 'none';
  const wrap = document.getElementById('logoWrap');
  const fallback = document.createElement('div');
  fallback.textContent = 'Codex Collection';
  fallback.style.fontWeight = '900';
  fallback.style.fontSize = 'clamp(2rem,6vw,4rem)';
  fallback.style.color = '#fff';
  wrap.appendChild(fallback);
});
</script>
</body>
</html>